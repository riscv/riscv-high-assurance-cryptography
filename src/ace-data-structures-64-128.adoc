[[Cryptographic-Contexts]]
=== Cryptographic Contexts

A CC contains two fields: the *metadata* and the *content*.
The metadata section is (mostly) algorithm independent and architected.
The content blocks is algorithm-specific and contains key material and possibly other algorithm-specific data.

[[Metadata]]
=== Metadata ASection Format

We now describe the extended version of the metadata.

[[ACE-metadata-extended]]
.Metadata: 128-bit version
[width="100%",cols=">9%,^9%,17%,57%,8%",options="header"]
|===
|     Field | Bits | Name                   | Description | Type
|       [0] |   1  | Format                 | 1 for the extended metadata format. | Public
|     [8:1] |   8  | Algorithm              | Algorithm (such as primitive or mode). | Public
|    [10:9] |   2  | Side Channel Protected | Set if we require the implementation of the algorithm to provide Side Channel Protection. | Public
|   [12:11] |   2  | Direction Policy       | Use for encryption/decryption/both (only for enc/dec primitives or modes). | Public
|   [14:13] |   2  | Key Type               | By explicit value / Immutable (index) / Internally generated. | Public
|   [18:15] |   4  | Locale                 | Field which is either -1 or an index into the Locale Secrets Table. | Public
|   [20:19] |   2  | Complete               | Whether the CC is complete (00) or interrupted while being configured (01), imported (10) or exported (11). Necessary to know whether to restart operations. | Public
|   [24:21] |   4  | Stage/Direction        | Which internal stage the algorithm is, as defined by ace_stage or implicitly. Must be ZERO on configuration. This is algorithm defined. | Private
|   [28:25] |   4  | Use Policy 1           | Is a User (if bit 28 set)/Supervisor or Virtual Supervisor (bit 29 set)/Hypervisor (bit 30 set)/Machine (bit 31 set) forbidden to USE this key? | Private
|   [30:29] |   2  | Use Policy 2           | If bit 32, resp., 33, is set, then restrict the _use_ of the CC to the `ASID`, resp., `VMID` specified in Use Policy 3, resp., Use Policy 4.  | Private
|      [31] |   1  | Reserved               | Undefined.  | Private
|   [47:32] |  16  | Use Policy 3           | Zero if bit 32 unset, else `ASID` to enforce.  | Private
|   [61:48] |  14  | Use Policy 4           | Zero if bit 33 unset, else `VMID` to enforce.  | Private
|   [63:62] |   2  | Reserved               | Undefined.  | Private
|   [67:64] |   4  | Version                | Metadata format version | Public
|   [83:68] |  16  | `partialsccif`         | (Partial SCC Implementation Format) ID of the µarchitectural format for CCs with interrupted operations. | Public
|  [115:84] |  28  | `marchpriv`            | Implementation private metadata | Private
| [127:112] |  16  | Reserved               | Reserved for future versions | Private
|===

*Remark {counter:remark}.* In the 128-bit version of the metadata, the first 64-bit word (i.e., at the lowest address) contains bits [63:0] and the second 64-bit word (i.e., at the byte address of the first word, plus 8) contains bits [127:64].

*Remark {counter:remark}.*
[.red]#*We may have to redefine this!* `partialsccif` is defined with a process similar to the `marchid` register.
While we do not mandate a specific format for the plaintext data underlying the SCC for an incomplete CC, we require the implementations to register any change to this format, whether they are open or closed source, in other words to request a new `partialsccif` value for each new format they use for the purpose.
// These formats will be documented and published in an appendix by RVI.
Since there are not many meaningful ways to parse a SCC, and likely very few efficient formats, 16 bits are likely to be abundant.
This field is used to determine whether the exported format from a suspended configure, import or export operation is compatible with the current microarchitecture, in which case the suspended operation can be resumed, otherwise the operation must be restarted anyway. All implementations must support restart, resuming is optional.#

// If is derived from the JEDEC Standard Manufacturer’s Identification Code as follows.
// The most significant bit is set to 1 if the format is private and commercial JEDEC or to 0 if the format is documented.
// If the most significant  bit is set to 1, then the remaining 23 bits are
// the 10-bit bank (number of `0x7F` Continuation Codes, minus one), a 7-bit offset, and a 6-bit revision number
// If the most significant bit is set to 0, then the remaining 23 bits are assigned and maintained by RVI to distinguish mutually non-compatible formats.
// However, since we do not expect many different formats,

*Remark {counter:remark}.* Filtering according to Supervisor Domains/Worlds is not currently supported, since in this case we believe that re-configuring the CTK is a more solid approach. This also allows us to avoid having to define an even longer metadata format, at least for now.

=== Formats of Configuration Inputs and Sealed Configuration Contexts

==== Configuration Input

*TBD*

==== Sealed Configuration Context



.Generation of the SCC from a CC with extended metadata format
[source,sail]
----
metadata : bits(128);
let P : array of bits(256) = content;
M : array of bits(256);
let N : bits(96) = random(96 bits);
Kenc : bits(256);
Kauth : bits(128);
{Kenc, Kauth} = RFC8452_KeyDeriv(CTK);
let SIV : bits(96) = POLYVAL(Kauth, N @ metadata @ IntToString32(len of content in bytes) @ content)[95:0];
let tmp : bits(128) = AESE256(Kenc, SIV @ 0x0000_0000);
M[0][127:0] = (metadata[127:84] xor tmp[127:84])
            @ metadata[83:0]
M[1][127:0] = 0x0000_0000 @ N;
M[2][127:0] = SIV @ 0x0000_0000;
foreach(i from 0 to num_blocks(P)-1) {
     M[i+3][127:0] = (block i of P) xor AESE256(Kenc, SIV @ (binary(i+1)[31:0]));
}
----
